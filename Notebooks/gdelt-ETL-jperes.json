{"paragraphs":[{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579250933530_-2045651318","id":"20200117-084853_890706269","dateCreated":"2020-01-17T08:48:53+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2529","text":"import sys.process._\nimport java.net.URL\nimport java.io.File\nimport java.io.File\nimport java.nio.file.{Files, StandardCopyOption}\nimport java.net.HttpURLConnection \nimport org.apache.spark.sql.functions._\n\n\ndef fileDownloader(urlOfFileToDownload: String, fileName: String) = {\n    val url = new URL(urlOfFileToDownload)\n    val connection = url.openConnection().asInstanceOf[HttpURLConnection]\n    connection.setConnectTimeout(5000)\n    connection.setReadTimeout(5000)\n    connection.connect()\n\n    if (connection.getResponseCode >= 400)\n        println(\"error\")\n    else\n        url #> new File(fileName) !!\n}","dateUpdated":"2020-01-17T08:49:12+0000"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579250952712_1521947598","id":"20200117-084912_1192902524","dateCreated":"2020-01-17T08:49:12+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2606","text":"fileDownloader(\"http://data.gdeltproject.org/gdeltv2/masterfilelist.txt\", \"/mnt/tmp/masterfilelist.txt\") // save the list file to the Spark Master","dateUpdated":"2020-01-17T08:49:23+0000"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"sh","editOnDblClick":false,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/sh"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579250963376_-41926759","id":"20200117-084923_2034320177","dateCreated":"2020-01-17T08:49:23+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2681","text":"%sh\nls -lrth /mnt/tmp |grep masterfilelistimport org.apache.spark.sql.SQLContext\n\nval sqlContext = new SQLContext(sc)\nval filesDF = sqlContext.read.\n                    option(\"delimiter\",\" \").\n                    option(\"infer_schema\",\"true\").\n                    csv(\"s3a://jperes-gdelt/masterfilelist.txt\").\n                    withColumnRenamed(\"_c0\",\"size\").\n                    withColumnRenamed(\"_c1\",\"hash\").\n                    withColumnRenamed(\"_c2\",\"url\").\n                    cachefilesDF.show(false)","dateUpdated":"2020-01-17T08:51:22+0000"},{"text":"import com.amazonaws.services.s3.AmazonS3Client\nimport com.amazonaws.auth.BasicAWSCredentials\nimport com.amazonaws.auth.BasicSessionCredentials\nval AWS_ID = \"ASIA4XEAYHWQQVQ6LA4C\"\nval AWS_KEY = \"6dv4d+7TJq/e1fFDJUPgjJqqZghJ53EHBszSye/A\"\nval AWS_TOKEN = \"FwoGZXIvYXdzECkaDIWAamlCdmT90ssgNyK9AQITk0934H6cAz592eEEe8GzL2LpdJkgHBibR8pZUMzpXrjaqDFDwFUfy5yB47m8UiPr2NaFp9wuZA68pZFTRpoXrxUkhyTfAYCOK8QenPnSYCJfdbUEOqjp+249Th91A+JoQIhfla1P8fMv0GlpDxYSJ2cedrlnre5ibtXBcgwXqTp8+JY5jeWkFFTxh/fvnRYDISsqKALHlY0mxiAv59pmifAdYtag7urmyh+ReBouJS/u1DgawsTmcDqAnyiLz4XxBTItyh2E8bSf7035728/EC1ve18zKMbfweX16SDcA2cj32GMQDsqpN+Da1BAYJBA\"\n// la classe AmazonS3Client n'est pas serializable\n// on rajoute l'annotation @transient pour dire a Spark de ne pas essayer de serialiser cette classe et l'envoyer aux executeurs\n@transient val awsClient = new AmazonS3Client(new BasicSessionCredentials(AWS_ID, AWS_KEY, AWS_TOKEN) )\nsc.hadoopConfiguration.set(\"fs.s3a.aws.credentials.provider\", \"org.apache.hadoop.fs.s3a.TemporaryAWSCredentialsProvider\")\nsc.hadoopConfiguration.set(\"fs.s3a.access.key\", AWS_ID) // mettre votre ID du fichier credentials.csv\nsc.hadoopConfiguration.set(\"fs.s3a.secret.key\", AWS_KEY) // mettre votre secret du fichier credentials.csv\nsc.hadoopConfiguration.set(\"fs.s3a.session.token\", AWS_TOKEN)\nawsClient.putObject(\"jperes-gdelt\", \"masterfilelist.txt\", new File( \"/mnt/tmp/masterfilelist.txt\") )","user":"anonymous","dateUpdated":"2020-01-17T08:50:05+0000","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579250994326_-1784200705","id":"20200117-084954_466427010","dateCreated":"2020-01-17T08:49:54+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2753"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579251071695_-1073088580","id":"20200117-085111_788630888","dateCreated":"2020-01-17T08:51:11+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2897","text":"val sampleDF = filesDF.filter(col(\"url\").contains(\"/201812\")).cache","dateUpdated":"2020-01-17T08:51:31+0000"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579251101824_417618376","id":"20200117-085141_1090087684","dateCreated":"2020-01-17T08:51:41+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2973","text":"\n\nobject AwsClient{\n    val s3 = new AmazonS3Client(new BasicSessionCredentials(AWS_ID, AWS_KEY, AWS_TOKEN) )\n}\n\n\nsampleDF.select(\"url\").repartition(100).foreach( r=> {\n            val URL = r.getAs[String](0)\n            val fileName = r.getAs[String](0).split(\"/\").last\n            val dir = \"/mnt/tmp/\"\n            val localFileName = dir + fileName\n            fileDownloader(URL,  localFileName)\n            val localFile = new File(localFileName)\n            AwsClient.s3.putObject(\"jperes-gdelt\", fileName, localFile )\n            localFile.delete()\n            \n})","dateUpdated":"2020-01-17T08:51:53+0000"},{"user":"anonymous","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1579251113575_-814456582","id":"20200117-085153_205427140","dateCreated":"2020-01-17T08:51:53+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3045"}],"name":"gdelt-ETL-jperes","id":"2EZ5FBSNY","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"sh:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}